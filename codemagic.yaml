workflows:
  ios-altstore-debug:
    name: DEBUG AltStore Build
    instance_type: mac_mini_m1
    environment:
      groups:
        - apple_certs  # Optional, create in Codemagic UI if you have certs
      flutter: stable
      xcode: latest
    scripts:
      - name: DEBUG - Initial Setup
        script: |
          echo "ðŸ” DEBUG MODE STARTED"
          echo "========================"
          echo "ðŸ“ Current directory:"
          pwd
          ls -la
          echo ""
          echo "ðŸ“± iOS project status:"
          if [ -d "ios" ]; then
            echo "âœ… iOS folder exists"
            ls -la ios/
          else
            echo "âŒ iOS folder missing"
          fi
          echo ""
          echo "ðŸ“„ pubspec.yaml (first 20 lines):"
          head -20 pubspec.yaml
          echo ""
          
      - name: DEBUG - Fix Dependency
        script: |
          echo "ðŸ”§ DEBUG: Fixing dependency..."
          echo "Before fix:"
          grep -n "code_text_field" pubspec.yaml || echo "Not found"
          
          # Backup
          cp pubspec.yaml pubspec.yaml.original
          
          # Try multiple fix methods
          echo "Attempting fix method 1..."
          sed -i.bak 's/code_text_field: ^2\.3\.0/code_text_field: ^1\.1\.0/' pubspec.yaml
          
          echo "After fix:"
          grep -n "code_text_field" pubspec.yaml
          
          echo "Diff:"
          diff -u pubspec.yaml.original pubspec.yaml | head -10 || true
          
      - name: DEBUG - Flutter Packages
        script: |
          echo "ðŸ“¦ DEBUG: Getting Flutter packages..."
          echo "Running: flutter pub get"
          flutter pub get 2>&1 | tee pub_get.log
          PUB_EXIT_CODE=${PIPESTATUS[0]}
          
          echo ""
          echo "ðŸ“Š Package get result: Exit code $PUB_EXIT_CODE"
          echo "Last 20 lines of output:"
          tail -20 pub_get.log
          
          if [ $PUB_EXIT_CODE -ne 0 ]; then
            echo "âŒ ERROR: flutter pub get failed"
            echo "Full error:"
            grep -A5 -B5 "error\|Error\|ERROR" pub_get.log
          else
            echo "âœ… flutter pub get successful"
          fi
          
      - name: DEBUG - Check iOS Project
        script: |
          echo "ðŸ“± DEBUG: iOS Project Analysis"
          echo "================================"
          
          if [ ! -d "ios" ]; then
            echo "âŒ iOS folder missing, creating..."
            flutter create . --platforms=ios --org com.example.oled
          fi
          
          echo "ðŸ“ iOS structure:"
          find ios -name "*.xcodeproj" -o -name "*.xcworkspace" -o -name "Podfile" -o -name "Info.plist" | sort
          
          echo ""
          echo "ðŸ“„ Info.plist content:"
          if [ -f "ios/Runner/Info.plist" ]; then
            plutil -p ios/Runner/Info.plist | head -30
          else
            echo "âš ï¸ Info.plist not found"
          fi
          
      - name: DEBUG - CocoaPods Installation
        script: |
          echo "â˜•ï¸ DEBUG: CocoaPods..."
          echo "Checking pod version:"
          pod --version 2>/dev/null || echo "pod not in PATH"
          
          echo "Installing pods..."
          cd ios
          pod install --repo-update 2>&1 | tee pod_install.log
          POD_EXIT_CODE=${PIPESTATUS[0]}
          cd ..
          
          echo "Pod install exit code: $POD_EXIT_CODE"
          echo "Last 30 lines of pod output:"
          tail -30 ios/pod_install.log
          
      - name: DEBUG - Build Attempt
        script: |
          echo "ðŸ—ï¸ DEBUG: Building iOS..."
          echo "Command: flutter build ios --release --no-codesign --verbose"
          
          # Clean first
          flutter clean 2>&1 | tail -10
          
          # Build with full logging
          flutter build ios --release --no-codesign --verbose 2>&1 | tee flutter_build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          echo ""
          echo "ðŸ“Š Build result: Exit code $BUILD_EXIT_CODE"
          echo ""
          echo "ðŸ”Ž ERROR ANALYSIS:"
          echo "=================="
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "âœ… Build succeeded!"
            echo "Looking for .app file..."
            find . -name "Runner.app" -type d 2>/dev/null
          else
            echo "âŒ Build failed with code $BUILD_EXIT_CODE"
            echo ""
            echo "ðŸ“„ LAST 50 LINES OF BUILD LOG:"
            echo "==============================="
            tail -50 flutter_build.log
            echo ""
            echo "ðŸ”´ ERRORS FOUND:"
            echo "================"
            grep -i "error\|failed\|failed to\|could not\|unable to" flutter_build.log | head -20
            echo ""
            echo "âš ï¸ WARNINGS FOUND:"
            echo "=================="
            grep -i "warning" flutter_build.log | head -10
            echo ""
            echo "ðŸ’¡ POSSIBLE SOLUTIONS:"
            echo "======================"
            # Check for common errors
            if grep -q "Development Team" flutter_build.log; then
              echo "1. Need to set Development Team in Xcode"
            fi
            if grep -q "code sign" flutter_build.log; then
              echo "2. Code signing issue - try different approach"
            fi
            if grep -q "Podfile" flutter_build.log; then
              echo "3. CocoaPods issue - check pod install"
            fi
          fi
          
      - name: DEBUG - Alternative Build Methods
        script: |
          echo "ðŸ”„ DEBUG: Trying alternative build methods..."
          echo ""
          
          # Method 1: Direct xcodebuild
          echo "Method 1: xcodebuild direct..."
          cd ios
          xcodebuild clean 2>&1 | tail -10
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM="" 2>&1 | tee xcode_build.log | tail -30
          cd ..
          
          # Method 2: Build for simulator
          echo ""
          echo "Method 2: Simulator build..."
          flutter build ios --simulator --release 2>&1 | tail -30
          
      - name: DEBUG - Find and Package
        script: |
          echo "ðŸ“¦ DEBUG: Looking for build outputs..."
          echo ""
          
          # Search everywhere
          echo "Searching for Runner.app:"
          find . -name "Runner.app" -type d 2>/dev/null | while read app; do
            echo "Found: $app"
            echo "Size: $(du -sh "$app" | cut -f1)"
            echo "Location: $(dirname "$app")"
            echo ""
          done
          
          # Try to package whatever we find
          APP_PATHS=$(find . -name "Runner.app" -type d 2>/dev/null | head -1)
          
          if [ -n "$APP_PATHS" ]; then
            echo "âœ… Found .app, attempting to package..."
            for APP_PATH in $APP_PATHS; do
              BUILD_DIR=$(dirname "$APP_PATH")
              IPA_NAME="OLED_Editor_$(basename "$BUILD_DIR").ipa"
              
              echo "Packaging from: $BUILD_DIR"
              cd "$BUILD_DIR"
              rm -rf Payload 2>/dev/null
              mkdir Payload
              cp -r Runner.app Payload/
              zip -qr "$IPA_NAME" Payload
              
              echo "Created: $(pwd)/$IPA_NAME"
              ls -lh "$IPA_NAME"
              echo ""
              
              # Copy to root for artifacts
              cp "$IPA_NAME" ../../ 2>/dev/null || true
            done
          else
            echo "âŒ No Runner.app found anywhere!"
            echo ""
            echo "ðŸ“ Build directory contents:"
            ls -la build/ 2>/dev/null || echo "No build directory"
            echo ""
            echo "ðŸ“ iOS build contents:"
            ls -la ios/build/ 2>/dev/null || echo "No ios/build directory"
          fi
          
    artifacts:
      - "*.ipa"
      - "*.log"
      - "ios/*.log"
      - "pub_get.log"
      - "flutter_build.log"
      - "pubspec.yaml"
      - "pubspec.yaml.original"
      
    publishing:
      scripts:
        - name: Summary
          script: |
            echo "ðŸ“Š BUILD SUMMARY"
            echo "================"
            echo "Artifacts created:"
            ls -la *.ipa *.log 2>/dev/null || echo "No artifacts"
            echo ""
            echo "If build failed, check the .log files above for errors."