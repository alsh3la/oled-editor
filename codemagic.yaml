workflows:
  ios-build:
    name: Build OLED iOS
    instance_type: mac_mini_m1
    environment:
      flutter: stable
      xcode: latest
    scripts:
      # STEP 1: FIX DEPENDENCY (ONLY THIS)
      - name: Fix Dependency
        script: |
          echo "ðŸ”§ Fixing code_text_field from 2.3.0 to 1.1.0..."
          sed -i '' 's/code_text_field: ^2\.3\.0/code_text_field: ^1\.1\.0/g' pubspec.yaml
          
      # STEP 2: GET PACKAGES
      - name: Get Packages
        script: |
          echo "ðŸ“¦ Getting dependencies..."
          flutter pub get
          
      # STEP 3: BUILD DIRECTLY - NO FLUTTER CREATE!
      - name: Build iOS App
        script: |
          echo "ðŸ—ï¸ Building YOUR app (not creating new)..."
          
          # Clean previous builds but keep iOS project
          flutter clean
          
          # Build without generating new project
          flutter build ios --release --no-codesign --verbose 2>&1 | tee build.log
          
          # Check if successful
          if [ $? -eq 0 ]; then
            echo "âœ… Build completed"
          else
            echo "âš ï¸ Build may have warnings, checking for .app anyway..."
          fi
          
      # STEP 4: VERIFY .APP WAS CREATED
      - name: Check Build Output
        script: |
          echo "ðŸ” Checking build results..."
          
          if [ -d "build/ios/iphoneos/Runner.app" ]; then
            APP_SIZE=$(du -sh build/ios/iphoneos/Runner.app | cut -f1)
            echo "âœ… Runner.app created: $APP_SIZE"
            echo "ðŸ“ Contents:"
            find build/ios/iphoneos/Runner.app -type f | head -10
          else
            echo "âŒ ERROR: No Runner.app found!"
            echo "ðŸ“„ Build log (last 50 lines):"
            tail -50 build.log
            echo "ðŸ” Searching for any build output:"
            find build -type f -name "*.app" 2>/dev/null
            exit 1
          fi
          
      # STEP 5: CREATE IPA
      - name: Create IPA
        script: |
          echo "ðŸ“¦ Creating IPA..."
          
          # Clean previous artifacts
          rm -rf Payload OLED_Editor.ipa 2>/dev/null || true
          
          # Create IPA
          mkdir Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          zip -r OLED_Editor.ipa Payload
          
          # Verify IPA
          IPA_SIZE=$(du -h OLED_Editor.ipa | cut -f1)
          echo "âœ… IPA created: OLED_Editor.ipa ($IPA_SIZE)"
          
    artifacts:
      - "OLED_Editor.ipa"
      - "build.log"